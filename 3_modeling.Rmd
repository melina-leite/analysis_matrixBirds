---
title: "Modeling"
author: "Melina Leite"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
    fig_heigth: 20
  pdf_document:
    highlight: tango
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = T, warning = F, fig.align = "center", message = F,
  error = F, cache = T
)
library(knitr)
library(tidyverse); library(cowplot); library(patchwork)
library(lme4)
theme_set(theme_cowplot())
```


Loading auxiliary function for R2 calculations
```{r}
source("r2_auxiliary_function.R")
```

Loading data
```{r}
load("datasets.Rdata")
```


Standardizing continuous variables for modeling



# Individual models for each trait

## Body size

```{r, eval=F}
bodyhigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                        forest_site400*lbody_size + 
                        (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                        (lbody_size|paisagem) + (lbody_size|ponto),
                      family=binomial, data=high.esp,
                      nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                       optCtrl = list(maxfun = 500000)))

bodylow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*lbody_size + forest_land*lbody_size +
                         (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size|paisagem) + (lbody_size|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))

bodyhigh.gen4at  <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400*lbody_size + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (lbody_size|paisagem) + (lbody_size|ponto),
                        family=binomial, data=high.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))

bodylow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*lbody_size + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size|paisagem) + (lbody_size|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
```

## Predição

```{r}
# mod 4a
cob.caf <- seq(min(high.esp$forest_site400), max(high.esp$forest_site400), length.out=20)
forest_site400caf <- seq(min(high.esp$forest_site400o), max(high.esp$forest_site400o), length.out=20)
cob.pas <- seq(min(low.esp$forest_site400), max(low.esp$forest_site400), length.out=20)
forest_site400pas <- seq(min(low.esp$forest_site400o), max(low.esp$forest_site400o), length.out=20)

body <- c(5, 100, 500)
peso.high.esp <- (body - mean(high.esp$body_size))/sd(high.esp$body_size)
peso.high.gen <- (body - mean(high.gen$body_size))/sd(high.gen$body_size)
peso.low.gen <- (body - mean(low.gen$body_size))/sd(low.gen$body_size)

nhigh.esp <- expand.grid(forest_site400=cob.caf, lbody_size=peso.high.esp)
nhigh.esp$pred <- predict(bodyhigh.esp4at, newdata=nhigh.esp, re.form=NA,
                        type="response")
nhigh.esp$body <- rep(body, each=20)
nhigh.esp$forest_site400o <- rep(forest_site400caf, 3) 
nhigh.gen <- expand.grid(forest_site400=cob.caf, lbody_size=peso.high.gen)
nhigh.gen$pred <- predict(bodyhigh.gen4at, newdata=nhigh.gen, re.form=NA,
                        type="response")
nhigh.gen$body <- rep(body, each=20)
nhigh.gen$forest_site400o <- rep(forest_site400caf, 3) 
nlow.gen <- expand.grid(forest_site400=cob.pas, lbody_size=peso.low.gen)
nlow.gen$pred <- predict(bodylow.gen4at, newdata=nlow.gen, re.form=NA,
                        type="response")
nlow.gen$body <- rep(body, each=20)
nlow.gen$forest_site400o <- rep(forest_site400pas, 3) 

m4a <- rbind(nhigh.esp, nhigh.gen, nlow.gen) %>%
  mutate(matriz = rep(c("Coffee","Coffee", "Pasture"), each=60),
         habitat = rep(c("Specialists","Generalists","Generalists"), each=60),
         forest_land = "NA", forest_lando="NA") %>%
  select(forest_site400,lbody_size,forest_land, pred,forest_site400o,body,forest_lando,matriz,habitat)

# mod 42
cobl.pas <- seq(min(low.esp$forest_site400), max(low.esp$forest_site400), length.out=20)
forest_site400pas <- seq(min(low.esp$forest_site400o), max(low.esp$forest_site400o), length.out=20)
paisa <- c(30)
cobp.pas <- (paisa-mean(low.esp$forest_lando))/sd(low.esp$forest_lando)

peso.low.esp <- (body - mean(low.esp$body_size))/sd(low.esp$body_size)
nlow.esp <- expand.grid(forest_site400=cobl.pas,lbody_size=peso.high.esp, 
                       forest_land = cobp.pas)
nlow.esp$pred <- predict(bodylow.esp42t, newdata=nlow.esp, re.form=NA,
                        type="response")
nlow.esp$forest_site400o <- rep(forest_site400pas, 3) 
nlow.esp$body <- rep(body, each=20)
nlow.esp$forest_lando <- rep(paisa, each=60)
nlow.esp$matriz <- "Pasture"
nlow.esp$habitat <- "Specialists"
```

```{r}
rbind(m4a, nlow.esp) %>%
  ggplot(aes(x=forest_site400o, y=pred, col=as.factor(body))) + 
  geom_line() +
  facet_grid(habitat~matriz) +
  scale_linetype_discrete(name="Landscape cover (%)") +
  scale_color_discrete(name="Body mass (g)")
```

```{r}
labi <- c(`5`= "5 g", `100`= "100 g", `500`= "500 g", `Specialists`= "Specialists",
          `Generalists` = "Generalists")
dadob <- rbind(m4a, nlow.esp) %>% 
  mutate(habitat = fct_relevel(habitat, "Specialists", "Generalists"))


figbody <- ggplot(dadob, aes(x=forest_site400o, y=pred, col=matriz)) + 
  geom_line(size=1.5) +
  facet_grid(habitat~as.factor(body), labeller=as_labeller(labi))+
 scale_color_manual(name="", 
                     labels=c("High quality", 
                                              "Low quality"),
                     values=c("darkgreen", "sandybrown")) +
  scale_x_continuous(name="Local forest cover (%)", breaks=c(30,60)) +
  scale_y_continuous(name="Occurrence probability", 
                     breaks = c(0,0.1,0.2), limits = c(0,0.2)) +
  theme(strip.text.x = element_text(size=12, margin = margin(r=2,l=2,t=2,b=2)),
        strip.text.y = element_blank(),
        text = element_text(size=14),
        axis.text = element_text(size=12),
        legend.position = "none") +
  ggtitle("Body mass")
figbody
```

```{r, eval=F}
jpeg("figures/trait_bodymass.jpg", width = 16, height = 10, res=150, units="cm" )
figbody
dev.off()
```


# Nest

```{r, eval=F}
nesthigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*nest + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (nest|paisagem) + (nest|ponto),
                       family=binomial, data=high.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
nestlow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*nest + forest_land*nest +
                         (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (nest|paisagem) + (nest|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
nesthigh.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*nest + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (nest|paisagem) + (nest|ponto),
                       family=binomial, data=high.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
nestlow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*nest + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (nest|paisagem) + (nest|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
```

## Predição

Predição
```{r}
# mod 4a
nhigh.esp <- expand.grid(forest_site400=cob.caf, nest = unique(high.esp$nest))
nhigh.esp$pred <- predict(nesthigh.esp4at, newdata=nhigh.esp, re.form=NA,
                        type="response")
nhigh.esp$forest_site400o <- rep(forest_site400caf, 3) 
nhigh.gen <- expand.grid(forest_site400=cob.caf, nest = unique(high.gen$nest))
nhigh.gen$pred <- predict(nesthigh.gen4at, newdata=nhigh.gen, re.form=NA,
                        type="response")
nhigh.gen$forest_site400o <- rep(forest_site400caf, 3) 
nlow.gen <- expand.grid(forest_site400=cob.pas,  nest = unique(low.gen$nest))
nlow.gen$pred <- predict(nestlow.gen4at, newdata=nlow.gen, re.form=NA,
                        type="response")
nlow.gen$forest_site400o <- rep(forest_site400pas, 3) 

m4a <- rbind(nhigh.esp, nhigh.gen, nlow.gen) %>%
  mutate(matriz = rep(c("Coffee", "Coffee", "Pasture"), each=60),
         habitat = rep(c("Specialists","Generalists","Generalists"), each=60),
         forest_land = "NA", forest_lando="NA") %>%
 select(forest_site400,nest,forest_land, pred, forest_site400o,forest_lando,matriz,habitat)

# m42
nlow.esp <- expand.grid(forest_site400=cobl.pas,  nest = unique(high.esp$nest),
                       forest_land = cobp.pas)
nlow.esp$pred <- predict(nestlow.esp42t, newdata=nlow.esp, re.form=NA,
                        type="response")
nlow.esp$forest_site400o <- rep(forest_site400pas, 3) 
nlow.esp$forest_lando <- rep(paisa, each=30)
nlow.esp$matriz <- "Pasture"
nlow.esp$habitat <- "Specialists"
```

```{r}
rbind(m4a, nlow.esp) %>%
 ggplot(aes(x=forest_site400o, y=pred, col=nest,
           linetype=as.factor(forest_lando))) + 
  geom_line() +
  facet_grid(habitat~matriz) +
  scale_linetype_discrete(name="Landscape cover (%)") +
  scale_color_discrete(name="Nest type")
```

```{r}
labi <-c(`cavities`= "Cavities", `closed`= "Closed", 
          `open_semi`= "Open", `Specialists`= "Specialists",
          `Generalists` = "Generalists")
dadon <- rbind(m4a, nlow.esp) %>% 
  mutate(habitat = fct_relevel(habitat, "Specialists", "Generalists"))

fignest <- ggplot(dadon, aes(x=forest_site400o, y=pred, col=matriz)) + 
  geom_line(size=1.5) +
  facet_grid(habitat~nest, labeller=as_labeller(labi))+
  scale_color_manual(name="", 
                     labels=c("High quality", 
                              "Low quality"),
                     values=c("darkgreen", "sandybrown")) +
 scale_x_continuous(name="Local forest cover (%)", breaks=c(30,60)) +
  scale_y_continuous(name="", 
                     breaks = c(0,0.1,0.2), limits = c(0,0.2)) +
  theme(strip.text.x = element_text(size=12,
                                    margin = margin(r=2,l=2,t=2,b=2)),
        strip.text.y = element_text(size=12, 
                                    margin = margin(r=2,l=2,t=2,b=2)),
        text = element_text(size=14),
        axis.text.y = element_blank(),
       # axis.line.y = element_blank(),
        axis.text = element_text(size=12),
        legend.position = "none") +
  ggtitle("Nest type")
fignest
```

```{r, eval=F}
# figura pdf
#pdf("figuras/trait_nest.pdf", width = 8, height = 5)
jpeg("figuras/trait_nest.jpg", width = 16, height = 10, res=150, units="cm" )
fignest
dev.off()
```



# Diet
```{r, eval=F}
diethigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*diet + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (diet|paisagem) + (diet|ponto),
                       family=binomial, data=high.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
dietlow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*diet + forest_land*diet +
                         (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (diet|paisagem) + (diet|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
diethigh.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*diet + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (diet|paisagem) + (diet|ponto),
                       family=binomial, data=high.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
dietlow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*diet + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (diet|paisagem) + (diet|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
```

## Predição

Predição
```{r}
#Modelo 4a
nhigh.esp <- expand.grid(forest_site400=cob.caf, diet = unique(high.esp$diet))
nhigh.esp$pred <- predict(diethigh.esp4at, newdata=nhigh.esp, re.form=NA,
                        type="response")
nhigh.esp$forest_site400o <- rep(forest_site400caf, 3) 
nhigh.gen <- expand.grid(forest_site400=cob.caf, diet = unique(high.gen$diet))
nhigh.gen$pred <- predict(diethigh.gen4at, newdata=nhigh.gen, re.form=NA,
                        type="response")
nhigh.gen$forest_site400o <- rep(forest_site400caf, 5) 
nlow.gen <- expand.grid(forest_site400=cob.pas,  diet = unique(low.gen$diet))
nlow.gen$pred <- predict(dietlow.gen4at, newdata=nlow.gen, re.form=NA,
                        type="response")
nlow.gen$forest_site400o <- rep(forest_site400pas, 5) 

m4a <- rbind(nhigh.esp, nhigh.gen, nlow.gen) %>%
  mutate(matriz = rep(c("Coffee", "Coffee", "Pasture"), c(60,100,100)),
    habitat = rep(c("Specialists","Generalists","Generalists"),c(60,100,100)),
    forest_land = "NA", forest_lando="NA") %>%
 select(forest_site400,diet,forest_land, pred, forest_site400o,forest_lando,matriz,habitat)

#Modelo 42
nlow.esp <- expand.grid(forest_site400=cobl.pas,  diet = unique(low.esp$diet),
                       forest_land = cobp.pas)
nlow.esp$pred <- predict(dietlow.esp42t, newdata=nlow.esp, re.form=NA,
                        type="response")
nlow.esp$forest_site400o <- rep(forest_site400pas, 3) 
nlow.esp$forest_lando <- rep(paisa, each=30)
nlow.esp$matriz <- "Pasture"
nlow.esp$habitat <- "Specialists"
```

```{r}
rbind(m4a, nlow.esp) %>%
  ggplot(aes(x=forest_site400o, y=pred, col=diet,
           linetype=as.factor(forest_lando))) + 
  geom_line() +
  facet_grid(habitat~matriz) +
  scale_linetype_discrete(name="Landscape cover (%)") +
  scale_color_discrete(name="Nest type")
```

```{r}
labi <- c(`insectivorous`= "Insectivorous", `onivorous`= "Onivorous", 
          `frugivoryvorous`= "frugivoryvorous", `nectarivorous` = "Nectarivorous",
          `granivorous` = "Granivorous",`Specialists`= "Specialists",
          `Generalists` = "Generalists")
dadod <- rbind(m4a, nlow.esp) %>% 
  mutate(habitat = fct_relevel(habitat, "Specialists", "Generalists"),
         diet = fct_relevel(diet, "insectivorous","onivorous",
                             "frugivoryvorous","granivorous", "nectarivorous"))

figdiet <- ggplot(dadod, aes(x=forest_site400o, y=pred, col=matriz)) + 
  geom_line(size=1.5) +
  facet_grid(habitat~diet, labeller=as_labeller(labi))+
  scale_color_manual(name="Matrix type", 
                     labels=c("High quality", 
                              "Low quality"),
                     values=c("darkgreen", "sandybrown")) +
 scale_x_continuous(name="Local forest cover (%)", breaks=c(30,60)) +
  scale_y_continuous(name="Occurrence probability", 
                     breaks = c(0,0.1,0.2), limits = c(0,0.2)) +
  theme(strip.text.x = element_text(size=12, margin = margin(r=2,l=2,t=2,b=2)),
        strip.text.y = element_text(size=12, margin = margin(t=2,b=2,r=2,l=2)),
        text = element_text(size=14),
        axis.text = element_text(size=12),
        legend.text = element_text(size=11),
        legend.title = element_text(size=11),
   #    legend.justification = c(1, 0), legend.position = c(1, 0.7),
        legend.position= "right",
        legend.box.backlower_stratumnd = element_rect(colour="darkgray")) +
  ggtitle("Main diet")
figdiet
figdiet2 <- figdiet + theme(legend.position = "none")
legenda <- get_legend(figdiet)
```

```{r, eval=F}
jpeg("figuras/trait_diet.jpg", width = 20, height = 12, res=150, units="cm" )
figdiet
dev.off()
```

```{r FIGURE 3 TRAITS, eval=F}
jpeg("figuras/all_traits.jpg", width = 20, height = 20, res=150, units="cm" )
(figdiet2+legenda +plot_layout(widths = c(1,0.15)))/(figbody+fignest) 
dev.off()
```

## % frugivoryvory

```{r, eval=F}
frugivoryhigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*frugivory + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (frugivory|paisagem) + (frugivory|ponto),
                 family=binomial, data=high.esp,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
frugivorylow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*frugivory + forest_land*frugivory +
                   (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (frugivory|paisagem) + (frugivory|ponto),
                 family=binomial, data=low.esp,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
frugivoryhigh.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*frugivory + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (frugivory|paisagem) + (frugivory|ponto),
                 family=binomial, data=high.gen,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
frugivorylow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*frugivory + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (frugivory|paisagem) + (frugivory|ponto),
                 family=binomial, data=low.gen,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
```

Predição
```{r}
# Modelo 4a
frugivory <- c(0, 50, 100)
frugivory.high.esp <- (frugivory - mean(high.esp$frugivoryo))/sd(high.esp$frugivoryo)
frugivory.low.esp <- (frugivory - mean(low.esp$frugivoryo))/sd(low.esp$frugivoryo)
frugivory.high.gen <- (frugivory - mean(high.gen$frugivoryo))/sd(high.gen$frugivoryo)
frugivory.low.gen <- (frugivory - mean(low.gen$frugivoryo))/sd(low.gen$frugivoryo)

nhigh.esp <- expand.grid(forest_site400=cob.caf, frugivory=frugivory.high.esp)
nhigh.esp$pred <- predict(frugivoryhigh.esp4at, newdata=nhigh.esp, re.form=NA,
                        type="response")
nhigh.esp$frugivoryo <- rep(frugivory, each=20)
nhigh.esp$forest_site400o <- rep(forest_site400caf, 3) 
nhigh.gen <- expand.grid(forest_site400=cob.caf, frugivory=frugivory.high.gen)
nhigh.gen$pred <- predict(frugivoryhigh.gen4at, newdata=nhigh.gen, re.form=NA,
                        type="response")
nhigh.gen$frugivoryo <- rep(frugivory, each=20)
nhigh.gen$forest_site400o <- rep(forest_site400caf, 3) 
nlow.gen <- expand.grid(forest_site400=cob.pas, frugivory=frugivory.low.gen)
nlow.gen$pred <- predict(frugivorylow.gen4at, newdata=nlow.gen, re.form=NA,
                        type="response")
nlow.gen$frugivoryo <- rep(frugivory, each=20)
nlow.gen$forest_site400o <- rep(forest_site400pas, 3) 

m4a <- rbind(nhigh.esp, nhigh.gen, nlow.gen) %>%
  mutate(matriz = rep(c("cafe", "cafe", "pasto"), each=60),
     habitat = rep(c("Specialists","Generalists","Generalists"), c(60,60,60)),
    forest_land = "NA", forest_lando="NA") %>%
 select(forest_site400,frugivory,forest_land, pred, forest_site400o,frugivoryo, forest_lando,matriz,habitat)

# Modelo 42
nlow.esp <- expand.grid(forest_site400=cobl.pas, frugivory=frugivory.low.esp, 
                       forest_land = cobp.pas)
nlow.esp$pred <- predict(frugivorylow.esp42t, newdata=nlow.esp, re.form=NA,
                        type="response")
nlow.esp$forest_site400o <- rep(forest_site400pas, 3) 
nlow.esp$frugivoryo <- rep(frugivory, each=20)
nlow.esp$forest_lando <- rep(paisa, each=30)
nlow.esp$matriz <- "pasto"
nlow.esp$habitat <- "Specialists"
```

```{r}
rbind(m4a, nlow.esp) %>%
  ggplot(aes(x=forest_site400o, y=pred, col=as.factor(frugivoryo))) + 
  geom_line() +
  facet_grid(habitat~matriz)+
  scale_linetype_discrete(name="Landscape cover (%)") +
  scale_color_discrete(name="frugivoryvory (%)")
```

```{r}
labi <- c(`0`= "0%", `50`= "50%", `100`= "100%", `Specialists`= "Specialists",
          `Generalists` = "Generalists")
dado <- rbind(m4a, nlow.esp) %>% 
  mutate(habitat = fct_relevel(habitat, "Specialists", "Generalists"))

figfrugivory<- ggplot(dado, aes(x=forest_site400o, y=pred, col=matriz)) + 
  geom_line(size=1.5) +
  facet_grid(habitat~frugivoryo, labeller=as_labeller(labi))+
  scale_color_manual(name="Matrix", 
                     labels=c("High quality", 
                                              "Low quality"),
                     values=c("darkgreen", "sandybrown")) +
  ylab("Occurrence probability") +
  xlab("Local forest cover (%)") +
  ylim(0,0.16) +
  theme(strip.text.x = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        strip.text.y = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        text = element_text(size=10),
        axis.text = element_text(size=10),
        legend.position = "right") +
  ggtitle("frugivoryvory")
figfrugivory
```

```{r, eval=F}
# figura pdf
#pdf("figuras/trait_diet.pdf", width = 8, height = 5)
jpeg("figuras/trait_frugivoryvory.jpg", width = 20, height = 10, res=150, units="cm" )
figfrugivory
dev.off()
```

# % Insectivory

```{r, eval=F}
insehigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*inse + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (inse|paisagem) + (inse|ponto),
                 family=binomial, data=high.esp,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
inselow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*inse + forest_land*inse +
                   (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (inse|paisagem) + (inse|ponto),
                 family=binomial, data=low.esp,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
insehigh.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*inse + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (inse|paisagem) + (inse|ponto),
                 family=binomial, data=high.gen,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
inselow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*inse + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (inse|paisagem) + (inse|ponto),
                 family=binomial, data=low.gen,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
```

Predição
```{r}
# Modelo 4a
inse <- c(0, 50, 100)
inse.high.esp <- (inse - mean(high.esp$inseo))/sd(high.esp$inseo)
inse.low.esp <- (inse - mean(low.esp$inseo))/sd(low.esp$inseo)
inse.high.gen <- (inse - mean(high.gen$inseo))/sd(high.gen$inseo)
inse.low.gen <- (inse - mean(low.gen$inseo))/sd(low.gen$inseo)

nhigh.esp <- expand.grid(forest_site400=cob.caf, inse=inse.high.esp)
nhigh.esp$pred <- predict(insehigh.esp4at, newdata=nhigh.esp, re.form=NA,
                        type="response")
nhigh.esp$inseo <- rep(inse, each=20)
nhigh.esp$forest_site400o <- rep(forest_site400caf, 3) 
nhigh.gen <- expand.grid(forest_site400=cob.caf, inse=inse.high.gen)
nhigh.gen$pred <- predict(insehigh.gen4at, newdata=nhigh.gen, re.form=NA,
                        type="response")
nhigh.gen$inseo <- rep(inse, each=20)
nhigh.gen$forest_site400o <- rep(forest_site400caf, 3) 
nlow.gen <- expand.grid(forest_site400=cob.pas, inse=inse.low.gen)
nlow.gen$pred <- predict(inselow.gen4at, newdata=nlow.gen, re.form=NA,
                        type="response")
nlow.gen$inseo <- rep(inse, each=20)
nlow.gen$forest_site400o <- rep(forest_site400pas, 3) 

m4a <- rbind(nhigh.esp, nhigh.gen, nlow.gen) %>%
  mutate(matriz = rep(c("cafe", "cafe", "pasto"), each=60),
         habitat = rep(c("Specialists","Generalists","Generalists"), each=60),
         forest_land = "NA", forest_lando="NA") %>%
 select(forest_site400,inse,forest_land, pred, forest_site400o,inseo, forest_lando,matriz,habitat)

# Modelo 42
nlow.esp <- expand.grid(forest_site400=cobl.pas, inse=inse.low.esp, 
                       forest_land = cobp.pas)
nlow.esp$pred <- predict(inselow.esp42t, newdata=nlow.esp, re.form=NA,
                        type="response")
nlow.esp$forest_site400o <- rep(forest_site400pas, 3) 
nlow.esp$inseo <- rep(inse, each=20)
nlow.esp$forest_lando <- rep(paisa, each=30)
nlow.esp$matriz <- "pasto"
nlow.esp$habitat <- "Specialists"
```

```{r}
rbind(m4a, nlow.esp) %>%
  ggplot(aes(x=forest_site400o, y=pred, col=as.factor(inseo))) + 
  geom_line() +
  facet_grid(habitat~matriz)+
  scale_linetype_discrete(name="Landscape cover (%)") +
  scale_color_discrete(name="Insetivory (%)")
```

```{r}
labi <- c(`0`= "0%", `50`= "50%", `100`= "100%", `Specialists`= "Specialists",
          `Generalists` = "Generalists")
dado <- rbind(m4a, nlow.esp) %>% 
  mutate(habitat = fct_relevel(habitat, "Specialists", "Generalists"))

figinse <- ggplot(dado, aes(x=forest_site400o, y=pred, col=matriz)) + 
  geom_line(size=1.5) +
  facet_grid(habitat~inseo, labeller=as_labeller(labi))+
  scale_color_manual(name="Matrix", 
                     labels=c("High quality", 
                                              "Low quality"),
                     values=c("darkgreen", "sandybrown")) +
  ylab("Occurrence probability") +
  xlab("Local forest cover (%)") +
  ylim(0,0.16) +
  theme(strip.text.x = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        strip.text.y = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        text = element_text(size=10),
        axis.text = element_text(size=10),
        legend.position = "right") +
  ggtitle("Insectivory")
figinse
```

```{r, eval=F}
# figura pdf
#pdf("figuras/trait_diet.pdf", width = 8, height = 5)
jpeg("figuras/trait_insect.jpg", width = 20, height = 10, res=150, units="cm" )
figinse
dev.off()
```

# Foraging stratu

```{r, eval=F}
estrahigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*stratum + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (stratum|paisagem) + (stratum|ponto),
                 family=binomial, data=high.esp,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
estralow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*stratum + forest_land*stratum +
                   (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (stratum|paisagem) + (stratum|ponto),
                 family=binomial, data=low.esp,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
estrahigh.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*stratum + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (stratum|paisagem) + (stratum|ponto),
                 family=binomial, data=high.gen,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
estralow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                   forest_site400*stratum + 
                   (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                   (stratum|paisagem) + (stratum|ponto),
                 family=binomial, data=low.gen,
                  nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                  optCtrl = list(maxfun = 500000)))
```

Predição
```{r}
# Modelo 4a
nhigh.esp <- expand.grid(forest_site400=cob.caf, stratum = unique(high.esp$stratum))
nhigh.esp$pred <- predict(estrahigh.esp4at, newdata=nhigh.esp, re.form=NA,
                        type="response")
nhigh.esp$forest_site400o <- rep(forest_site400caf, 3) 
nhigh.gen <- expand.grid(forest_site400=cob.caf, stratum = unique(high.gen$stratum))
nhigh.gen$pred <- predict(estrahigh.gen4at, newdata=nhigh.gen, re.form=NA,
                        type="response")
nhigh.gen$forest_site400o <- rep(forest_site400caf, 3) 
nlow.gen <- expand.grid(forest_site400=cob.pas,  stratum = unique(low.gen$stratum))
nlow.gen$pred <- predict(estralow.gen4at, newdata=nlow.gen, re.form=NA,
                        type="response")
nlow.gen$forest_site400o <- rep(forest_site400pas, 3) 

m4a <- rbind(nhigh.esp,nhigh.gen, nlow.gen) %>%
  mutate(matriz = rep(c("cafe", "cafe", "pasto"), each=60),
         habitat = rep(c("Specialists","Generalists","Generalists"),each=60),
         forest_land = "NA", forest_lando="NA") %>%
 select(forest_site400,stratum,forest_land, pred, forest_site400o,forest_lando,matriz,habitat)

# Modelo 42
nlow.esp <- expand.grid(forest_site400=cobl.pas,  stratum = unique(low.esp$stratum),
                       forest_land = cobp.pas)
nlow.esp$pred <- predict(estralow.esp42t, newdata=nlow.esp, re.form=NA,
                        type="response")
nlow.esp$forest_site400o <- rep(forest_site400pas, 3) 
nlow.esp$forest_lando <- rep(paisa, each=30)
nlow.esp$matriz <- "pasto"
nlow.esp$habitat <- "Specialists"
```

```{r}
rbind(m4a,nlow.esp) %>% ggplot(aes(x=forest_site400o, y=pred, col=stratum,
           linetype=as.factor(forest_lando))) + 
  geom_line() +
  facet_grid(habitat~matriz)+
  scale_linetype_discrete(name="Landscape cover (%)") +
  scale_color_discrete(name="stratum")
```

```{r}
labi <- c(`lower_stratumnd_under`= "lower_stratumnd-Understory", `mid_canopy`= "Midstory-Canopy", 
          `all`= "All", `Specialists`= "Specialists",
          `Generalists` = "Generalists")
dado <- rbind(m4a, nlow.esp) %>% 
  mutate(habitat = fct_relevel(habitat, "Specialists", "Generalists"))

figestra <- ggplot(dado, aes(x=forest_site400o, y=pred, col=matriz)) + 
  geom_line(size=1.5) +
  facet_grid(habitat~stratum, labeller=as_labeller(labi))+
  scale_color_manual(name="Matrix", 
                     labels=c("High quality", "Low quality"),
                     values=c("darkgreen", "sandybrown")) +
  ylab("Occurrence probability") +
  xlab("Local forest cover (%)") +
  ylim(0,0.16) +
  theme(strip.text.x = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        strip.text.y = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        text = element_text(size=10),
        axis.text = element_text(size=10),
        legend.position = "right") +
  ggtitle("Forraging stratum")
figestra
```

```{r, eval=F}
jpeg("figuras/trait_stratum.jpg", width = 20, height = 10, res=150, units="cm" )
figestra
dev.off()
```

# % Lower stratum

```{r, eval=F}
lower_stratumhigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                        forest_site400*lower_stratum + 
                        (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                        (lower_stratum|paisagem) + (lower_stratum|ponto),
                      family=binomial, data=high.esp,
                      nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                       optCtrl = list(maxfun = 500000)))
lower_stratumlow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                        forest_site400*lower_stratum + forest_land*lower_stratum +
                        (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                        (lower_stratum|paisagem) + (lower_stratum|ponto),
                      family=binomial, data=low.esp,
                      nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                       optCtrl = list(maxfun = 500000)))
lower_stratumhigh.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                        forest_site400*lower_stratum + 
                        (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                        (lower_stratum|paisagem) + (lower_stratum|ponto),
                      family=binomial, data=high.gen,
                      nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                       optCtrl = list(maxfun = 500000)))
lower_stratumlow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                        forest_site400*lower_stratum + 
                        (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                        (lower_stratum|paisagem) + (lower_stratum|ponto),
                      family=binomial, data=low.gen,
                      nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                       optCtrl = list(maxfun = 500000)))
```

## Predição
```{r}
#Modelo 4a
lower_stratum <- c(0, 50, 100)
lower_stratum.high.esp <- (lower_stratum - mean(high.esp$lower_stratumo))/sd(high.esp$lower_stratumo)
lower_stratum.low.esp <- (lower_stratum - mean(low.esp$lower_stratumo))/sd(low.esp$lower_stratumo)
lower_stratum.high.gen <- (lower_stratum - mean(high.gen$lower_stratumo))/sd(high.gen$lower_stratumo)
lower_stratum.low.gen <- (lower_stratum - mean(low.gen$lower_stratumo))/sd(low.gen$lower_stratumo)

nhigh.esp <- expand.grid(forest_site400=cob.caf, lower_stratum=lower_stratum.high.esp)
nhigh.esp$pred <- predict(lower_stratumhigh.esp4at, newdata=nhigh.esp, re.form=NA,
                        type="response")
nhigh.esp$lower_stratumo <- rep(lower_stratum, each=20)
nhigh.esp$forest_site400o <- rep(forest_site400caf, 3) 
nhigh.gen <- expand.grid(forest_site400=cob.caf, lower_stratum=lower_stratum.high.gen)
nhigh.gen$pred <- predict(lower_stratumhigh.gen4at, newdata=nhigh.gen, re.form=NA,
                        type="response")
nhigh.gen$lower_stratumo <- rep(lower_stratum, each=20)
nhigh.gen$forest_site400o <- rep(forest_site400caf, 3) 
nlow.gen <- expand.grid(forest_site400=cob.pas, lower_stratum=lower_stratum.low.gen)
nlow.gen$pred <- predict(lower_stratumlow.gen4at, newdata=nlow.gen, re.form=NA,
                        type="response")
nlow.gen$lower_stratumo <- rep(lower_stratum, each=20)
nlow.gen$forest_site400o <- rep(forest_site400pas, 3) 

m4a <- rbind(nhigh.esp, nhigh.gen, nlow.gen) %>%
  mutate(matriz = rep(c("cafe", "cafe", "pasto"), each=60),
         habitat = rep(c("Specialists","Generalists","Generalists"), each=60),
         forest_land = "NA", forest_lando="NA") %>%
 select(forest_site400,lower_stratum,forest_land, pred, forest_site400o,lower_stratumo,forest_lando,matriz,habitat)

#Modelo 42
nlow.esp <- expand.grid(forest_site400=cobl.pas, lower_stratum=lower_stratum.low.esp, 
                       forest_land = cobp.pas)
nlow.esp$pred <- predict(lower_stratumlow.esp42t, newdata=nlow.esp, re.form=NA,
                        type="response")
nlow.esp$forest_site400o <- rep(forest_site400pas, 3) 
nlow.esp$lower_stratumo <- rep(lower_stratum, each=20)
nlow.esp$forest_lando <- rep(paisa, each=30)
nlow.esp$matriz <- "pasto"
nlow.esp$habitat <- "Specialists"
```

```{r}
rbind(m4a, nlow.esp) %>%
  ggplot(aes(x=forest_site400o, y=pred, col=as.factor(lower_stratumo),
           linetype=as.factor(forest_lando))) + 
  geom_line() +
  facet_grid(habitat~matriz)+
  scale_linetype_discrete(name="Landscape cover (%)") +
  scale_color_discrete(name="lower_stratumnd (%)")
```

```{r}
labi <- c(`0`= "0%", `50`= "50%", `100`= "100%", `Specialists`= "Specialists",
          `Generalists` = "Generalists")
dado <- rbind(m4a, nlow.esp) %>% 
  mutate(habitat = fct_relevel(habitat, "Specialists", "Generalists"))

filower_stratum <- ggplot(dado, aes(x=forest_site400o, y=pred, col=matriz)) + 
  geom_line(size=1.5) +
  facet_grid(habitat~lower_stratumo, labeller=as_labeller(labi))+
  scale_color_manual(name="Matrix", 
                     labels=c("High quality", 
                                              "Low quality"),
                     values=c("darkgreen", "sandybrown")) +
  ylab("Occurrence probability") +
  xlab("Local forest cover (%)") +
  ylim(0,0.16) +
  theme(strip.text.x = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        strip.text.y = element_text(margin = margin(0.2,0.2,0.2,0.2, "cm")),
        text = element_text(size=10),
        axis.text = element_text(size=10),
        legend.position = "right") +
  ggtitle("Lower strata % use")
filower_stratum
```

```{r, eval=F}
jpeg("figuras/trait_lower_stratumnd.jpg", width = 20, height = 10, res=150, units="cm" )
filower_stratum
dev.off()
```



# Combined attributes models

```{r, eval=F}
bndghigh.esp4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*lbody_size + forest_site400*nest + forest_site400*diet + 
                         forest_site400*lower_stratum + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) + 
                         (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=high.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
bndglow.esp42t <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*lbody_size + forest_site400*nest + forest_site400*diet + 
                         forest_site400*lower_stratum +
                         forest_land*lbody_size + forest_land*nest + forest_land*diet +
                         forest_land*lower_stratum + 
                         (forest_site400 +forest_land |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) +
                         (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
bndghigh.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*lbody_size + forest_site400*nest + forest_site400*diet + 
                         forest_site400*lower_stratum +
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) +
                         (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=high.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))

bndglow.gen4at <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400*lbody_size + forest_site400*nest + forest_site400*diet + 
                         forest_site400*lower_stratum + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) + 
                          (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
```




# Summary modelos bndg

```{r}
summary(bndghigh.esp4at)
summary(bndglow.esp42t)
summary(bndghigh.gen4at)
summary(bndglow.gen4at)
```

# Resultados e figuras para artigo R2

## Figura dos R2 particionados

```{r}
vals <- data.frame(componente= c("condicional", "trait*env", "env|sp", "lands:sp", "site:sp", "trait|lands", "trait|site"),
      high.esp=r.quad(bndghigh.esp4at, "forest_site400")[,2]*100,
      low.esp=r.quad(bndglow.esp42t, c("forest_site400", "forest_land"))[,2]*100,
      high.gen=r.quad(bndghigh.gen4at, "forest_site400")[,2]*100,
      low.gen=r.quad(bndglow.gen4at, "forest_site400")[,2]*100)

vals2 <-  vals %>% gather("dataset", "R2", 2:5) %>% mutate(R2=round(R2)) %>%
  filter(componente != "condicional") %>%
  mutate(habitat = rep(c("Specialists", "Generalists"),
                       each=12),
         matrix = rep(c("High", "Low", "High", "Low"),
                      each=6))  %>%
  
  mutate(componente = fct_relevel(componente,"trait|site", "trait|lands", "site:sp", 
                                  "lands:sp", "trait*env","env|sp"),
         habitat = fct_relevel(habitat, "Specialists", "Generalists"),
         matrix = fct_relevel(matrix, "Low", "High")) %>%
  arrange(habitat,matrix,desc(componente)) %>%
  lower_stratump_by(habitat, matrix) %>%
  mutate(yis = cumsum(R2)-R2/2, 
         label = as.character(R2)) %>% unlower_stratump() %>%
  mutate(xis = rep(rep(c(1.35,2.35), each=6), 2))
vals2$label[17] <- ""

fig.part <- ggplot(vals2, aes(x=matrix, y=R2, fill=componente)) + geom_col(width=0.7) +
  scale_fill_manual(name="Model terms" ,
                    values = c("lightgrey","darkgrey","aquamarine1",
                               "aquamarine3", "slateblue1", "slateblue4")) +
  facet_wrap(~habitat)+
  scale_y_continuous(name= expression(~ R^2), breaks=seq(0,70,10),
                     limits=c(0,75)) +
  scale_x_discrete(name="Matrix quality") +
  theme(text = element_text(size=12),
        axis.text = element_text(size=12),
        strip.text = element_text(size=12, margin=margin(t=2,b=3))) +
geom_text_repel(data=vals2, aes(label=label, y=yis, x=xis), 
                segment.size = 0.15, size=3,
                #arrow = arrow(length = unit(0.02, "npc")),
                #segment.alpha = 0.7,
                show.legend=F,   nudge_x = 0.1, hjust=0)

fig.part
```


```{r, eval=F}
jpeg("figuras/fig_R2.jpg", width=20, height = 12, units="cm", res=150)
fig.part
dev.off()
```

## Figura trait contribution

(efeitos fixos - baselin) / (efeitos fixos + env.sp)

```{r}
atributo <- c( "combined","body mass","nest type","main diet","% fruits", 
               "% insects","% lower strata","foraging strata")

cafe.espe4a <- rbind(r.braak(bndghigh.esp4at, "forest_site400", c("lbody_size", "nest",
                                                                 "diet", "lower_stratum")),
                     r.braak(bodyhigh.esp4at,"forest_site400", "lbody_size"),
                     r.braak(nesthigh.esp4at,"forest_site400", "nest"),
                     r.braak(diethigh.esp4at,"forest_site400", "diet"),
                     r.braak(frugivoryhigh.esp4at, "forest_site400", "frugivory"),
                     r.braak(insehigh.esp4at, "forest_site400", "inse"),
                     r.braak(lower_stratumhigh.esp4at,"forest_site400", "lower_stratum"),
                     r.braak(estrahigh.esp4at, "forest_site400", "stratum")) %>%
  mutate(atributo = factor(rep(atributo,each=7), levels = atributo)) %>%
  spread(componente, valores)  %>%
  mutate_if(is.numeric, round, digits=2)
colnames(cafe.espe4a) <- c("Model","total", "fixed", "lands", "lands.sp","site", "site.sp",  "env.sp")

pase.espe42 <- rbind(r.braak(bndglow.esp42t, c("forest_site400", "forest_land"), 
                             c("lbody_size", "nest","diet", "lower_stratum")),
                     r.braak(bodylow.esp42t, c("forest_site400", "forest_land"), "lbody_size"), 
                     r.braak(nestlow.esp42t,c("forest_site400", "forest_land"), "nest"),
                     r.braak(dietlow.esp42t,c("forest_site400", "forest_land"), "diet"),
                     r.braak(frugivorylow.esp42t, c("forest_site400", "forest_land"), "frugivory"),
                     r.braak(inselow.esp42t, c("forest_site400", "forest_land"), "inse"),
                     r.braak(lower_stratumlow.esp42t,c("forest_site400", "forest_land"), "lower_stratum"),
                     r.braak(estralow.esp42t, c("forest_site400", "forest_land"), "stratum")) %>%
  mutate(atributo = factor(rep(atributo,each=7), levels = atributo)) %>%
  spread(componente, valores)  %>%
  mutate_if(is.numeric, round, digits=2)
colnames(pase.espe42) <- c("Model","total", "fixed", "lands", "lands.sp","site", "site.sp",  "env.sp")

cafe.gene4a <- rbind(r.braak(bndghigh.gen4at, "forest_site400", c("lbody_size", "nest",
                                                                 "diet", "lower_stratum")),
                     r.braak(bodyhigh.gen4at,"forest_site400", "lbody_size"),
                     r.braak(nesthigh.gen4at,"forest_site400", "nest"),
                     r.braak(diethigh.gen4at,"forest_site400", "diet"),
                     r.braak(frugivoryhigh.gen4at, "forest_site400","frugivory"),
                     r.braak(insehigh.gen4at, "forest_site400", "inse"),
                     r.braak(lower_stratumhigh.gen4at, "forest_site400", "lower_stratum"),
                     r.braak(estrahigh.gen4at, "forest_site400", "stratum")) %>%
  mutate(atributo = factor(rep(atributo,each=7), levels = atributo)) %>%
  spread(componente, valores)  %>%
  mutate_if(is.numeric, round, digits=2)
colnames(cafe.gene4a) <- c("Model","total", "fixed", "lands", "lands.sp","site", "site.sp",  "env.sp")

pase.gene4a <- rbind(r.braak(bndglow.gen4at, "forest_site400", c("lbody_size", "nest",
                                                                 "diet", "lower_stratum")),
                     r.braak(bodylow.gen4at,"forest_site400", "lbody_size"),
                     r.braak(nestlow.gen4at,"forest_site400", "nest"),
                     r.braak(dietlow.gen4at,"forest_site400", "diet"),
                     r.braak(frugivorylow.gen4at, "forest_site400", "frugivory"),
                     r.braak(inselow.gen4at, "forest_site400", "inse"),
                     r.braak(lower_stratumlow.gen4at,"forest_site400", "lower_stratum"),
                     r.braak(estralow.gen4at, "forest_site400", "stratum")) %>%
  mutate(atributo = factor(rep(atributo,each=7), levels = atributo)) %>%
  spread(componente, valores)  %>%
  mutate_if(is.numeric, round, digits=2)
colnames(pase.gene4a) <- c("Model","total", "fixed", "lands", "lands.sp","site", "site.sp",  "env.sp")

todos <- rbind(cafe.espe4a[,c(1,2,3,8,5,7,4,6)], pase.espe42[,c(1,2,3,8,5,7,4,6)], cafe.gene4a[,c(1,2,3,8,5,7,4,6)], pase.gene4a[,c(1,2,3,8,5,7,4,6)])
todos <- todos %>% mutate_if(is.numeric, function(x)x*100) %>%
  mutate(matrix = rep(c("cafe", "pasto", "cafe", "pasto"),each=8),
         habitat = rep(c("Specialists", "Generalists"), each=16)) 
```

```{r}
baseline <- rbind(r.quad(mhigh.esp4a)[2,],
                  r.quad(mlow.esp42, c("forest_site400", "forest_land"))[2,],
                  r.quad(mhigh.gen4a)[2,],
                  r.quad(mlow.gen4a)[2,]) %>%
  mutate(matrix=c("cafe", "pasto", "cafe", "pasto"),
         habitat = c("Specialists", "Specialists", "Generalists",
                                "Generalists"),
        xis = c(Inf, -Inf, Inf, -Inf),
        valores = round(valores*100))

todos %>% gather("term", "part.var", 2:7) %>% 
  filter(term %in% c("fixed", "env.sp")) %>%
ggplot(aes(x=Model, y=part.var, fill=term)) + geom_col() +
  geom_hline(data=baseline, aes(yintercept=valores, x=xis), linetype="dashed") +
  facet_grid(habitat~matrix) +
  theme(axis.text.x = element_text(angle = 90, hjust=1) ) 
```

```{r}
contri <- todos %>% left_join(baseline[,2:4], by=c("matrix", "habitat")) %>%
  mutate(trait.c = round(100*(fixed-valores)/(fixed+env.sp)),
         habitat = fct_relevel(as.factor(habitat), "Specialists", "Generalists"),
         Model = fct_relevel(Model, "combined","main diet","% insects", "foraging strata","nest type","body mass","% fruits","% lower strata")) %>%
  arrange(Model) %>%
  mutate(xis = rep(1:8, each=4))

figtrait.contri <- ggplot(contri, aes(x=xis, y=trait.c, col=matrix)) + 
  geom_point(size=3) +
  geom_line( size=1) +
  facet_grid(~habitat) +
  scale_x_continuous(breaks=1:8, labels=levels(contri$Model)) +
  scale_color_manual(name="Matrix",
                       labels = c("High quality", "Low quality"),
                       values = c("darkgreen", "sandybrown")) +
  xlab("") +
  ylab("Trait contribution (%)")+
  theme(axis.text.x = element_text(angle=45, hjust=1),
        text = element_text(size=10),
        axis.text = element_text(size=10),
        legend.position = "bottom") 
```

```{r, eval=F}
jpeg("figuras/fig_trait_contribution.jpg", width=20, height = 12, units="cm", res=150)
figtrait.contri
dev.off()
```


## Figura trait importance 

fixo - baseline / fixo
```{r}
dfig1 <- todos %>% left_join(baseline[,2:4], by=c("matrix", "habitat")) %>%
  mutate(trait.c = round(100*(fixed-valores)/(fixed)),
         habitat = fct_relevel(as.factor(habitat), "Specialists", "Generalists"),
         Model = fct_relevel(Model, "combined","main diet","% insects", "foraging strata","nest type","body mass","% fruits","% lower strata")) %>%
  arrange(Model) %>%
  mutate(xis = rep(1:8, each=4))
dfig1$trait.c[is.na(dfig1$trait.c)] <- 0

figtrait.imp <- ggplot(dfig1, aes(x=xis, y=trait.c, col=matrix)) + 
  geom_point(size=3) +
  geom_line( size=1) +
  facet_grid(~habitat) +
  scale_x_continuous(breaks=1:8, labels=levels(dfig1$Model)) +
  scale_color_manual(name="Matrix",
                       labels = c("High quality", "Low quality"),
                       values = c("darkgreen", "sandybrown")) +
  xlab("") +
  ylab("(fixo - baseline)/fixo")+
  theme(axis.text.x = element_text(angle=45, hjust=1),
        text = element_text(size=10),
        axis.text = element_text(size=10),
        legend.position = "bottom") 
```

```{r, eval=F}
jpeg("figuras/fig_trait_importance1.jpg", width=20, height = 12, units="cm", res=150)
figtrait.imp
dev.off()
```

soma todos os R2 dos termos com trait, subtrai do R2 baseline (R2 fixo modelo sem traits) dividido por todos termos de seleçao (inclui env.sp):

(fixo + trait.site + trait.lands - baseline) / (fixo + env.sp + trait.site + trait.lands)

```{r}
dfig <- todos %>% left_join(baseline[,2:4], by=c("matrix", "habitat")) %>%
  mutate(trait.c = round(100*(fixed+site+lands-valores)/(fixed+site+lands+env.sp)),
         habitat = fct_relevel(as.factor(habitat), "Specialists", "Generalists"),
         Model = fct_relevel(Model, "combined","main diet","% insects", "foraging strata","nest type","body mass","% fruits","% lower strata")) %>%
  arrange(Model) %>%
  mutate(xis = rep(1:8, each=4))

figtrait.imp <- ggplot(dfig, aes(x=xis, y=trait.c, col=matrix)) + 
  geom_point(size=3) +
  geom_line( size=1) +
  facet_grid(~habitat) +
  ylim(0,30) +
  scale_x_continuous(breaks=1:8, labels=levels(dfig$Model)) +
  scale_color_manual(name="Matrix",
                       labels = c("High quality", "Low quality"),
                       values = c("darkgreen", "sandybrown")) +
  xlab("") +
  ylab("Trait importance (%)")+
  theme(axis.text.x = element_text(angle=45, hjust=1),
        text = element_text(size=10),
        axis.text = element_text(size=10),
        legend.position = "bottom") 
```

```{r, eval=F}
jpeg("figuras/fig_trait_importance.jpg", width=20, height = 12, units="cm", res=150)
figtrait.imp
dev.off()
```

# Métrica de trait importance

Modelos sem interacao atriuto ambiente

```{r, eval=F}
bndghigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lbody_size + nest + diet + lower_stratum + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) + 
                         (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=high.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
bndglow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lbody_size +nest +diet + lower_stratum +
                         forest_land+lbody_size + forest_land+nest + forest_land+diet +
                         forest_land+lower_stratum + 
                         (forest_site400 +forest_land |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) +
                         (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
bndghigh.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lbody_size +nest + diet + lower_stratum +
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) +
                         (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=high.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))

bndglow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lbody_size + nest + diet + lower_stratum + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size + nest + diet + lower_stratum|paisagem) + 
                          (lbody_size + nest + diet + lower_stratum|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
```

```{r, eval=F}
bodyhigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                        forest_site400 + lbody_size + 
                        (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                        (lbody_size|paisagem) + (lbody_size|ponto),
                      family=binomial, data=high.esp,
                      nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                       optCtrl = list(maxfun = 500000)))

bodylow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400 + lbody_size + forest_land*lbody_size +
                         (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size|paisagem) + (lbody_size|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))

bodyhigh.gen4atv  <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+lbody_size + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (lbody_size|paisagem) + (lbody_size|ponto),
                        family=binomial, data=high.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))

bodylow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lbody_size + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lbody_size|paisagem) + (lbody_size|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
nesthigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+nest + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (nest|paisagem) + (nest|ponto),
                        family=binomial, data=high.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
nestlow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+nest + forest_land+nest +
                          (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (nest|paisagem) + (nest|ponto),
                        family=binomial, data=low.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
nesthigh.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+nest + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (nest|paisagem) + (nest|ponto),
                        family=binomial, data=high.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
nestlow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+nest + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (nest|paisagem) + (nest|ponto),
                        family=binomial, data=low.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))

diethigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+diet + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (diet|paisagem) + (diet|ponto),
                        family=binomial, data=high.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
dietlow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+diet + forest_land+diet +
                          (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (diet|paisagem) + (diet|ponto),
                        family=binomial, data=low.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
diethigh.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+diet + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (diet|paisagem) + (diet|ponto),
                        family=binomial, data=high.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
dietlow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+diet + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (diet|paisagem) + (diet|ponto),
                        family=binomial, data=low.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))

frugivoryhigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+frugivory + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (frugivory|paisagem) + (frugivory|ponto),
                        family=binomial, data=high.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
frugivorylow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+frugivory + forest_land+frugivory +
                          (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (frugivory|paisagem) + (frugivory|ponto),
                        family=binomial, data=low.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
frugivoryhigh.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+frugivory + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (frugivory|paisagem) + (frugivory|ponto),
                        family=binomial, data=high.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
frugivorylow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+frugivory + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (frugivory|paisagem) + (frugivory|ponto),
                        family=binomial, data=low.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))

insehigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+inse + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (inse|paisagem) + (inse|ponto),
                       family=binomial, data=high.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
inselow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+inse + forest_land+inse +
                         (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (inse|paisagem) + (inse|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
insehigh.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+inse + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (inse|paisagem) + (inse|ponto),
                       family=binomial, data=high.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
inselow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+inse + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (inse|paisagem) + (inse|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))


estrahigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+stratum + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (stratum|paisagem) + (stratum|ponto),
                        family=binomial, data=high.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
estralow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+stratum + forest_land+stratum +
                          (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (stratum|paisagem) + (stratum|ponto),
                        family=binomial, data=low.esp,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
estrahigh.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+stratum + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (stratum|paisagem) + (stratum|ponto),
                        family=binomial, data=high.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))
estralow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                          forest_site400+stratum + 
                          (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                          (stratum|paisagem) + (stratum|ponto),
                        family=binomial, data=low.gen,
                        nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                         optCtrl = list(maxfun = 500000)))

lower_stratumhigh.esp4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lower_stratum + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lower_stratum|paisagem) + (lower_stratum|ponto),
                       family=binomial, data=high.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
lower_stratumlow.esp42tv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lower_stratum + forest_land+lower_stratum +
                         (forest_site400 +forest_land|sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lower_stratum|paisagem) + (lower_stratum|ponto),
                       family=binomial, data=low.esp,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
lower_stratumhigh.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lower_stratum + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lower_stratum|paisagem) + (lower_stratum|ponto),
                       family=binomial, data=high.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
lower_stratumlow.gen4atv <- glmer(cbind(occor, n.visit-occor) ~  
                         forest_site400+lower_stratum + 
                         (forest_site400 |sp) + (1|paisagem:sp) + (1|ponto:sp) + 
                         (lower_stratum|paisagem) + (lower_stratum|ponto),
                       family=binomial, data=low.gen,
                       nAGQ = 1, control = glmerControl(optimizer = "bobyqa",
                                                        optCtrl = list(maxfun = 500000)))
```

```{r}
cbeta <- function(mod.com.interacao, mod.sem.interacao, modelo="4a"){
  if(modelo=="4a"){
    cbeta = 1- (VarCorr(mod.com.interacao)$sp[2,2]/VarCorr(mod.sem.interacao)$sp[2,2])
  }
  if(modelo=="42"){
    cbeta <- 1-((VarCorr(mod.com.interacao)$sp[2,2]+VarCorr(mod.com.interacao)$sp[3,3])
               /(VarCorr(mod.sem.interacao)$sp[2,2]+VarCorr(mod.sem.interacao)$sp[3,3]))
  }
  return(round(100*cbeta))
}
```

```{r}
bndg <- c(cbeta(bndghigh.esp4at, bndghigh.esp4atv),
          cbeta(bndglow.esp42t, bndglow.esp42tv, "42"),
          cbeta(bndghigh.gen4at, bndghigh.gen4atv),
          cbeta(bndglow.gen4at, bndglow.gen4atv))

bd <- c(cbeta(bodyhigh.esp4at, bodyhigh.esp4atv),
        cbeta(bodylow.esp42t, bodylow.esp42tv, "42"),
        cbeta(bodyhigh.gen4at, bodyhigh.gen4atv),
        cbeta(bodylow.gen4at, bodylow.gen4atv))

ni <- c(cbeta(nesthigh.esp4at, nesthigh.esp4atv),
        cbeta(nestlow.esp42t, nestlow.esp42tv, "42"),
        cbeta(nesthigh.gen4at, nesthigh.gen4atv),
        cbeta(nestlow.gen4at, nestlow.gen4atv))

di <- c(cbeta(diethigh.esp4at, diethigh.esp4atv),
        cbeta(dietlow.esp42t, dietlow.esp42tv, "42"),
        cbeta(diethigh.gen4at, diethigh.gen4atv),
        cbeta(dietlow.gen4at, dietlow.gen4atv))

fr <- c(cbeta(frugivoryhigh.esp4at, frugivoryhigh.esp4atv),
        cbeta(frugivorylow.esp42t, frugivorylow.esp42tv, "42"),
        cbeta(frugivoryhigh.gen4at, frugivoryhigh.gen4atv),
        cbeta(frugivorylow.gen4at, frugivorylow.gen4atv))

ins <- c(cbeta(insehigh.esp4at, insehigh.esp4atv), 
         cbeta(inselow.esp42t, inselow.esp42tv, "42"),
         cbeta(insehigh.gen4at, insehigh.gen4atv),
         cbeta(inselow.gen4at, inselow.gen4atv))

es <- c(cbeta(estrahigh.esp4at, estrahigh.esp4atv),
        cbeta(estralow.esp42t, estralow.esp42tv, "42"),
        cbeta(estrahigh.gen4at, estrahigh.gen4atv),
        cbeta(estralow.gen4at, estralow.gen4atv))

gr <- c(cbeta(lower_stratumhigh.esp4at, lower_stratumhigh.esp4atv),
        cbeta(lower_stratumlow.esp42t, lower_stratumlow.esp42tv, "42"),
        cbeta(lower_stratumhigh.gen4at, lower_stratumhigh.gen4atv),
        cbeta(lower_stratumlow.gen4at, lower_stratumlow.gen4atv))
```

```{r}
tra <- data.frame(matrix = c("High quality", "Low quality", "High quality", "Low quality"),
                  habitat = c("Specialists", "Specialists","Generalists","Generalists"),
          bndg, bd, ni, di, fr, ins, es, gr)
colnames(tra)[3:10] <- c("Combined"," Body mass", "Nest type", "Main diet", 
                         "% frugivoryvory", "% insectivory",
                        "Foraging stratum", "% lower strata")
tra
# colocndo valor -1 por 0
tra[3,4] <- 0
```

```{r}
figtrait.env <- tra %>% gather("trait", "value", 3:10) %>%
  mutate(trait = fct_relevel(trait, "Combined","Nest type", "Main diet", 
                             "Foraging stratum", "% lower strata",
                             "Body mass", "% insectivory", "% frugivoryvory"),
         habitat = fct_relevel(habitat, "Specialists", "Generalists")) %>% 
  arrange(trait) %>%
  mutate(xis=rep(1:8, each=4)) %>%
  ggplot(aes(x=xis, y=value, col=matrix)) + geom_line(size=1) + geom_point(size=3) +
  facet_grid(~habitat) +
  scale_x_continuous(breaks=1:8, labels= c("Combined","Nest type", "Main diet", 
                                           "Foraging stratum", "% lower strata",
                                           "Body mass", "% insectivory", "% frugivoryvory")) +
  xlab("") +
  scale_color_manual(name="Matrix",
                     labels = c("High quality", "Low quality"),
                     values = c("darkgreen", "sandybrown")) +
  ylab("Trait importance (%)")+
  theme(axis.text.x = element_text(angle=45, hjust=1),
        text = element_text(size=12),
        axis.text = element_text(size=12),
        strip.text = element_text(size=12, margin=margin(t=2,b=3)),
        legend.justification = c(1, 0), legend.position = c(1, 0.75)) 
figtrait.env
```

```{r, eval=F}
jpeg("figuras/fig_traitXenv.jpg", width=20, height = 12, units="cm", res=150)
figtrait.env
dev.off()
```


# Saving models outputs

```{r, eval=F}
save(bodyhigh.esp4at, bodylow.esp42t, bodyhigh.gen4at, bodylow.gen4at,
     nesthigh.esp4at, nestlow.esp42t, nesthigh.gen4at, nestlow.gen4at,
     diethigh.esp4at, dietlow.esp42t, diethigh.gen4at, dietlow.gen4at,
     lower_stratumhigh.esp4at, lower_stratumlow.esp42t, lower_stratumhigh.gen4at, lower_stratumlow.gen4at,
     insehigh.esp4at, inselow.esp42t, insehigh.gen4at, inselow.gen4at,
     lower_stratumhigh.esp4at, lower_stratumlow.esp42t, lower_stratumhigh.gen4at, lower_stratumlow.gen4at,
     frugivoryhigh.esp4at, frugivorylow.esp42t, frugivoryhigh.gen4at, frugivorylow.gen4at,
     estrahigh.esp4at, estralow.esp42t, estrahigh.gen4at, estralow.gen4at,
     handwinghigh.esp4at, handwinglow.esp42t, handwinghigh.gen4at, handwinglow.gen4at,
     bndghigh.esp4at, bndglow.esp42t, bndghigh.gen4at, bndglow.gen4at,
     bndghhigh.esp4at, bndghlow.esp42t, bndghhigh.gen4at, bndghlow.gen4at,
     file="modelos_trait-site_terBraak.Rdata")

save(bodyhigh.esp4atv, bodylow.esp42tv, bodyhigh.gen4atv, bodylow.gen4atv,
     nesthigh.esp4atv, nestlow.esp42tv, nesthigh.gen4atv, nestlow.gen4atv,
     diethigh.esp4atv, dietlow.esp42tv, diethigh.gen4atv, dietlow.gen4atv,
     lower_stratumhigh.esp4atv, lower_stratumlow.esp42tv, lower_stratumhigh.gen4atv, lower_stratumlow.gen4atv,
     insehigh.esp4atv, inselow.esp42tv, insehigh.gen4atv, inselow.gen4atv,
     lower_stratumhigh.esp4atv, lower_stratumlow.esp42tv, lower_stratumhigh.gen4atv, lower_stratumlow.gen4atv,
     frugivoryhigh.esp4atv, frugivorylow.esp42tv, frugivoryhigh.gen4atv, frugivorylow.gen4atv,
     estrahigh.esp4atv, estralow.esp42tv, estrahigh.gen4atv, estralow.gen4atv,
    
     bndghigh.esp4atv, bndglow.esp42tv, bndghigh.gen4atv, bndglow.gen4atv,
     file="modelos_terBraak_seminteracao.Rdata")
```

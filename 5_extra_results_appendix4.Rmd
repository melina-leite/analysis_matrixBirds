---
title: "Appendix 4: Additional results"
#subtitle: "Supplementary material of Leite et al. 2019"
#author: "Melina de Souza Leite"
#date: "`r format(Sys.time(), '%d de %B de %Y')`"
bibliography: refs_appendix.bib
csl: journal-of-zoology.csl
output:
  pdf_document:
    highlight: zenburn
    toc: no
documentclass: article
classoption: a4paper
header-includes:
    - \usepackage{graphicx}
    - \usepackage{float}
    - \usepackage{setspace}\doublespacing
    - \setlength{\parindent}{4em}
    - \usepackage{indentfirst}
    - \usepackage{booktabs}
    - \usepackage{longtable}
    - \usepackage{array}
    - \usepackage{multirow}
    - \usepackage[table]{xcolor}
    - \usepackage{colortbl}
    - \usepackage{pdflscape}
    - \usepackage{tabu}
    - \usepackage{threeparttable}
    - \usepackage{threeparttablex}
    - \usepackage[normalem]{ulem}
    - \usepackage{makecell}
    - \usepackage{placeins}
    - \usepackage[margin=0.8in]{geometry}
---

\fontsize{11}{11}
\selectfont

```{r, include=FALSE}
options(kableExtra.latex.load_packages = FALSE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F, warning = F, fig.align = "center", message = F,
  error = F, cache = T, fig.pos="H")

library(knitr)
library(tidyverse); library(cowplot); library(patchwork)
theme_set(theme_cowplot())
library(lme4)
library(kableExtra)
```

```{r}
#carregando os dados
load("dados_abund_amb_trait.Rdata") 
load("dados_modelos.Rdata") 
source("r.quad_modelos.R" )
load("modelos_trait-site_terBraak.Rdata") # modelos terbraak com trait aleat
load("modelos_atributos.Rdata")  # modelos sem trait aleat
```


# Predictions for the trait-environment interactions 

We present the predicted response of probability of occurrence for the final models (trait-environment) for each dataset.

For the predictions, we categorized the body mass of the species into 3 intervals - equal or below 30g, above 30g and equal or below 100g, above 100g - and we used the predictions for the lowest, median and highest body mass values to represent these categories.The percentage of lower strata use was also categorized in 2 intervals - equal or below 50% and above 50% - and we used the predictions for the lowest and highest % of lower strata use to represent these categories.

In the plots, prediction lines are only available if there is any species with the combined trait value. For example, in Figure \ref{fig:fig.cafep} there are no frugivorou species with nests in cavities with body mass below 100g and lower strata use below 50%.

For the specialists in the pasture matrix (only model with the inclusion of landscape forest cover), we fixed the landscape forest cover in 30% (mean value for the dataset) to make predictions for local forest cover.

Gray lines in each plot represent the unique responses of the species in each combination of categorical trait values (main diet and nest type).

```{r}
### Café especialistas
A <- caf.ep %>% group_by(dieta, ninho) %>% 
  summarise(min.lbody = min(lbody_size),
            median.lbody = median(lbody_size),
            max.lbody = max(lbody_size),
            min.grou = min(grou),
            median.grou = median(grou),
            max.grou = max(grou)) %>%
  gather("lab.lbody", "lbody_size", min.lbody, median.lbody, max.lbody) %>%
  gather("lab.grou", "grou", min.grou, median.grou, max.grou) %>%
  dplyr::select(dieta, ninho, lbody_size, grou) %>%
  distinct() 

B <-caf.ep %>% group_by(dieta, ninho) %>% 
  summarise(min.size = min(body_size),
            median.size = median(body_size),
            max.size = max(body_size),
            min.ground = min(grouo),
            median.ground = median(grouo),
            max.ground = max(grouo)) %>%
  gather("lab.body", "body", min.size, median.size, max.size) %>%
  gather("lab.grou", "ground", min.ground,median.ground, max.ground) %>% 
  dplyr::select(dieta, ninho, body, ground) %>%
  distinct() 

natr <- cbind(A,B) %>% dplyr::select(-dieta...5,-ninho...6) %>%
  rename(dieta = "dieta...1", ninho="ninho...2")
natr$peso <- "between 31 and 100g"
natr$peso[natr$body >100] <- "above 100g"
natr$peso[natr$body <=30] <- "until 30g"
natr$peso <- fct_relevel(natr$peso, "until 30g", "between 31 and 100g", "above 100g")
natr$ground.cat <- "above 50%"
natr$ground.cat[natr$ground <=50] <- "below 50%"

natr <- natr[!duplicated(natr[,c(1,2,7,8)]), ] %>% 
  dplyr::slice(rep(1:n(), each=20))

natr$fc400 <- rep(seq(min(caf.ep$fc400), max(caf.ep$fc400), length.out = 20),
                  23)

natr$pred <- predict(bndgcaf.ep4at, newdata=natr, type="response", re.form=NA)
natr$cob <- natr$fc400*sd(caf.ep$fc400o) + mean(caf.ep$fc400o)

merda <- caf.ep
merda$pretes <- predict(bndgcaf.ep4a,type="response", re.form=~(fc400|sp))
merda$cob <- merda$fc400*sd(merda$fc400o) + mean(merda$fc400o)
# OBS: deveria usar o bndgcaf.ep4at -> mas nao funciona o predict, entao mantive o modelo anterior que nao tem o termo do terbraak
```

```{r fig.cafep, echo=F, fig.height=5, fig.cap="Predictions for forest specialists in the high-quality matrix region."}
ggplot(merda, aes(x=cob, y=pretes)) +
  geom_line(aes(fill=sp),alpha=0.15) +
  facet_grid(ninho~dieta)+
  geom_line(data=natr, aes(x=cob, y=pred, col=peso, linetype=ground.cat)) +
  theme(legend.position = "bottom",
        legend.justification = "center", legend.spacing.y = unit(-0.1, "cm"),
        legend.box = "vertical")+
 scale_y_continuous(name= "Occurrence probability", limits=c(0,0.85)) +
  scale_color_discrete(name="Weight") +
  scale_linetype_discrete(name= "% lower strata") +
  scale_x_continuous(name="Local forest cover (%)") +
   ggtitle("Specialists in the high-quality matrix")
```


```{r, echo=F, fig.height=4, fig.cap="Predictions for forest specialists in the low-quality matrix region."}
## PASTO GENERALISTA
A <- pas.ep %>% group_by(dieta, ninho) %>% 
  summarise(min.lbody = min(lbody_size),
            median.lbody = median(lbody_size),
            max.lbody = max(lbody_size),
            min.grou = min(grou),
            median.grou = median(grou),
            max.grou = max(grou)) %>%
  gather("lab.lbody", "lbody_size", min.lbody, median.lbody, max.lbody) %>%
  gather("lab.grou", "grou", min.grou, median.grou, max.grou) %>%
  dplyr::select(dieta, ninho, lbody_size, grou) %>%
  distinct() 

B <-pas.ep %>% group_by(dieta, ninho) %>% 
  summarise(min.size = min(body_size),
            median.size = median(body_size),
            max.size = max(body_size),
            min.ground = min(grouo),
            median.ground = median(grouo),
            max.ground = max(grouo)) %>%
  gather("lab.body", "body", min.size, median.size, max.size) %>%
  gather("lab.grou", "ground", min.ground,median.ground, max.ground) %>% 
  dplyr::select(dieta, ninho, body, ground) %>%
  distinct() 

natr <- cbind(A,B) %>% dplyr::select(-dieta...5,-ninho...6) %>%
  rename(dieta = "dieta...1", ninho="ninho...2")
natr$peso <- "between 31 and 100g"
natr$peso[natr$body >100] <- "above 100g"
natr$peso[natr$body <=30] <- "until 30g"
natr$peso <- fct_relevel(natr$peso, "until 30g", "between 31 and 100g", "above 100g")
natr$ground.cat <- "above 50%"
natr$ground.cat[natr$ground <=50] <- "below 50%"

natr <- natr[!duplicated(natr[,c(1,2,7,8)]), ] %>% 
  dplyr::slice(rep(1:n(), each=20))

natr$fc400 <- rep(seq(min(pas.ep$fc400), max(pas.ep$fc400), length.out = 20),
                  25)

natr$forest_2k <- (30 - mean(pas.ep$forest_2ko))/sd(pas.ep$forest_2ko)

natr$pred <- predict(bndgpas.ep42t, newdata=natr, type="response", re.form=NA)

natr$cob <- natr$fc400*sd(pas.ep$fc400o) + mean(pas.ep$fc400o)

merda <- pas.ep
merda$forest_2k <-  (30 - mean(pas.ep$forest_2ko))/sd(pas.ep$forest_2ko)
merda$pretes <- predict(bndgpas.ep42, newdata=merda, type="response", re.form=~(fc400|sp))
merda$cob <- merda$fc400*sd(merda$fc400o) + mean(merda$fc400o)

ggplot(merda, aes(x=cob, y=pretes)) +
  geom_line(aes(fill=sp),alpha=0.3) +
  facet_grid(ninho~dieta) +
  geom_line(data=natr, aes(x=cob, y=pred, col=peso, linetype=ground.cat),size=1) +
  theme(legend.position = "none")+
 scale_y_continuous(name= "Occurrence probability") +
  scale_color_discrete(name="Weight") +
  scale_linetype_discrete(name= "% lower strata") +
  scale_x_continuous(name="Local forest cover (%)") +
   ggtitle("Specialists in the low-quality matrix")
```

```{r, echo=F, fig.height=5, fig.cap="Predictions for forest generalists in the high-quality matrix region."}
### Café generalista
A <- caf.gp %>% group_by(dieta, ninho) %>% 
  summarise(min.lbody = min(lbody_size),
            median.lbody = median(lbody_size),
            max.lbody = max(lbody_size),
            min.grou = min(grou),
            median.grou = median(grou),
            max.grou = max(grou)) %>%
  gather("lab.lbody", "lbody_size", min.lbody, median.lbody, max.lbody) %>%
  gather("lab.grou", "grou", min.grou, median.grou, max.grou) %>%
  dplyr::select(dieta, ninho, lbody_size, grou) %>%
  distinct() 

B <-caf.gp %>% group_by(dieta, ninho) %>% 
  summarise(min.size = min(body_size),
            median.size = median(body_size),
            max.size = max(body_size),
            min.ground = min(grouo),
            median.ground = median(grouo),
            max.ground = max(grouo)) %>%
  gather("lab.body", "body", min.size, median.size, max.size) %>%
  gather("lab.grou", "ground", min.ground,median.ground, max.ground) %>% 
  dplyr::select(dieta, ninho, body, ground) %>%
  distinct() 

natr <- cbind(A,B) %>% dplyr::select(-dieta...5,-ninho...6) %>%
  rename(dieta = "dieta...1", ninho="ninho...2")
natr$peso <- "between 31 and 100g"
natr$peso[natr$body >100] <- "above 100g"
natr$peso[natr$body <=30] <- "until 30g"
natr$peso <- fct_relevel(natr$peso, "until 30g", "between 31 and 100g", "above 100g")
natr$ground.cat <- "above 50%"
natr$ground.cat[natr$ground <=50] <- "below 50%"

natr <- natr[!duplicated(natr[,c(1,2,7,8)]), ] %>% 
  dplyr::slice(rep(1:n(), each=20))

natr$fc400 <- rep(seq(min(caf.gp$fc400), max(caf.gp$fc400), length.out = 20),
                  34)

natr$pred <- predict(bndgcaf.gp4at, newdata=natr, type="response", re.form=NA)

natr$cob <- natr$fc400*sd(caf.gp$fc400o) + mean(caf.gp$fc400o)

merda <- caf.gp
merda$pretes <- predict(bndgcaf.gp4a,type="response", re.form=~(fc400|sp))
merda$cob <- merda$fc400*sd(merda$fc400o) + mean(merda$fc400o)

ggplot(merda, aes(x=cob, y=pretes)) +
  geom_line(aes(fill=sp),alpha=0.15) +
  facet_grid(ninho~dieta)+
  geom_line(data=natr, aes(x=cob, y=pred, col=peso, linetype=ground.cat)) +
 theme(legend.position = "bottom",
        legend.justification = "center", legend.spacing.y = unit(-0.1, "cm"),
        legend.box = "vertical")+
 scale_y_continuous(name= "Occurrence probability", limits=c(0,0.7)) +
  scale_color_discrete(name="Weight") +
  scale_linetype_discrete(name= "% lower strata") +
  scale_x_continuous(name="Local forest cover (%)") +
   ggtitle("Generalists in the high-quality matrix")
```

```{r, echo=F, fig.height=4, fig.cap="Predictions for forest generalists in the low-quality matrix region."}
### Pasto generalista
A <- pas.gp %>% group_by(dieta, ninho) %>% 
  summarise(min.lbody = min(lbody_size),
            median.lbody = median(lbody_size),
            max.lbody = max(lbody_size),
            min.grou = min(grou),
            median.grou = median(grou),
            max.grou = max(grou)) %>%
  gather("lab.lbody", "lbody_size", min.lbody, median.lbody, max.lbody) %>%
  gather("lab.grou", "grou", min.grou, median.grou, max.grou) %>%
  dplyr::select(dieta, ninho, lbody_size, grou) %>%
  distinct() 

B <-pas.gp %>% group_by(dieta, ninho) %>% 
  summarise(min.size = min(body_size),
            median.size = median(body_size),
            max.size = max(body_size),
            min.ground = min(grouo),
            median.ground = median(grouo),
            max.ground = max(grouo)) %>%
  gather("lab.body", "body", min.size, median.size, max.size) %>%
  gather("lab.grou", "ground", min.ground,median.ground, max.ground) %>% 
  dplyr::select(dieta, ninho, body, ground) %>%
  distinct() 

natr <- cbind(A,B) %>% dplyr::select(-dieta...5,-ninho...6) %>%
  rename(dieta = "dieta...1", ninho="ninho...2")
natr$peso <- "between 31 and 100g"
natr$peso[natr$body >100] <- "above 100g"
natr$peso[natr$body <=30] <- "until 30g"
natr$peso <- fct_relevel(natr$peso, "until 30g", "between 31 and 100g", "above 100g")
natr$ground.cat <- "above 50%"
natr$ground.cat[natr$ground <=50] <- "below 50%"

natr <- natr[!duplicated(natr[,c(1,2,7,8)]), ] %>% 
  dplyr::slice(rep(1:n(), each=20))

natr$fc400 <- rep(seq(min(pas.gp$fc400), max(pas.gp$fc400), length.out = 20),
                  34)

natr$pred <- predict(bndgpas.gp4at, newdata=natr, type="response", re.form=NA)

natr$cob <- natr$fc400*sd(pas.gp$fc400o) + mean(pas.gp$fc400o)

merda <- pas.gp
merda$pretes <- predict(bndgpas.gp4a,type="response", re.form=~(fc400|sp))
merda$cob <- merda$fc400*sd(merda$fc400o) + mean(merda$fc400o)

ggplot(merda, aes(x=cob, y=pretes)) +
  geom_line(aes(fill=sp),alpha=0.3) +
  facet_grid(ninho~dieta)+
  geom_line(data=natr, aes(x=cob, y=pred, col=peso, linetype=ground.cat),size=1) +
  theme(legend.position = "none")+
 scale_y_continuous(name= "Occurrence probability", limits=c(0,0.75)) +
  scale_color_discrete(name="Weight") +
  scale_linetype_discrete(name= "% lower strata") +
  scale_x_continuous(name="Local forest cover (%)") +
   ggtitle("Generalists in the low-quality matrix")
```

# Predicted response of each species to the local forest cover

Probability of occurence against number of detections for each species in each matrix quality region (\@ref(fig:intercept). Y axis are the logit transformed intercepts for each species. Tendency lines are linear models applied for each dataset, with confidence intervals for the estimates. Intercepts, overall probability of occurence for each species, increases with the number of detections - a proxy for overall abundances in the landscapes.

```{r intercept}
# n detecções
det.caf.ep <- caf.ep %>% group_by(sp) %>% summarise(detections = sum(ocor))
det.pas.ep <- pas.ep %>% group_by(sp) %>% summarise(detections = sum(ocor))
det.caf.gp <- caf.gp %>% group_by(sp) %>% summarise(detections = sum(ocor))
det.pas.gp <- pas.gp %>% group_by(sp) %>% summarise(detections = sum(ocor))

c.caf.ep <- coef(bndgcaf.ep4at)$sp[,c(1,2)] 
c.caf.ep$n <- det.caf.ep$detections 
c.pas.ep <- coef(bndgpas.ep42t)$sp[,c(1,2)] 
c.pas.ep$n <- det.pas.ep$detections 
c.caf.gp <- coef(bndgcaf.gp4at)$sp[,c(1,2)] 
c.caf.gp$n <- det.caf.gp$detections 
c.pas.gp <- coef(bndgpas.gp4at)$sp[,c(1,2)] 
c.pas.gp$n <- det.pas.gp$detections 

df <- rbind(c.caf.ep, c.pas.ep, c.caf.gp, c.pas.gp) %>% 
  mutate(matrix = rep(c("cafe", "pasto", "cafe", "pasto"), c(68,82,77,74)),
         habitat = rep(c("especialista", "generalista"), c(68+82, 77+74)))
df$intercept <- arm::invlogit(df$`(Intercept)`)

ggplot(df, aes(x=n, y=intercept, col=habitat)) + geom_point() + 
  geom_smooth(method="lm") +
  geom_hline(yintercept=0, col= "red", linetype="dashed") +
  facet_grid(~matrix,  labeller=as_labeller(c(cafe = "High quality", pasto="Low quality"))) +
  xlab("Number of detections") + ylab("Probability of occurence") +
  scale_color_discrete(name="", labels=c("Specialists","Generalists"))
```





```{r}
scaf.ep <- caf.ep
scaf.ep$pretes <- predict(bndgcaf.ep4a, newdata=scaf.ep, type="response", re.form=~(fc400|sp))

spas.ep <- pas.ep
spas.ep$forest_2k <- (30 - mean(pas.ep$forest_2ko))/sd(pas.ep$forest_2ko)
spas.ep$pretes <- predict(bndgpas.ep42, newdata=spas.ep, type="response", re.form=~(fc400|sp))
```

```{r, fig.height=16,fig.width=11}
rbind(scaf.ep, spas.ep) %>% mutate(matrix = rep(c("high quality", "low quality"),c(2720, 4264))) %>%
ggplot(aes(x=fc400o, y=pretes, col=matrix)) +
  geom_line() +
  facet_wrap(~sp, ncol=6) +
  theme(legend.position = "top")+
 scale_y_continuous(name= "Occurrence probability") +
  scale_linetype_discrete(name= "% lower strata") +
  scale_x_continuous(name="Local forest cover (%)") +
  ggtitle("Forest specialists")
```

```{r}
scaf.gp <- caf.gp
scaf.gp$pretes <- predict(bndgcaf.gp4a, newdata=scaf.gp, type="response", re.form=~(fc400|sp))

spas.gp <- pas.gp
spas.gp$pretes <- predict(bndgpas.gp4a, newdata=spas.gp, type="response", re.form=~(fc400|sp))
```

```{r, fig.height=18,fig.width=11}
rbind(scaf.gp, spas.gp) %>% mutate(matrix = rep(c("high quality", "low quality"),c(3080, 3848))) %>%
ggplot(aes(x=fc400o, y=pretes, col=matrix)) +
  geom_line() +
  facet_wrap(~sp, ncol=6) +
  theme(legend.position = "top")+
 scale_y_continuous(name= "Occurrence probability") +
  scale_linetype_discrete(name= "% lower strata") +
  scale_x_continuous(name="Local forest cover (%)") +
  ggtitle("Forest generalists")
```

---
title: 'Data preparation'
subtitle: "from Leite et al."
classoption: a4paper
output:
  pdf_document:
    toc: no
header-includes:
- \usepackage{graphicx}
- \usepackage{float}
- \usepackage{setspace}\doublespacing
- \setlength{\parindent}{4em}
#- \usepackage{indentfirst}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{placeins}
- \usepackage[margin=0.8in]{geometry}
documentclass: article
---

\fontsize{11}{11}
\selectfont


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = T, warning = F, fig.align = "center", message = F,
  error = F, cache = F, fig.pos="H")
library(knitr)
library(tidyverse)
library(tidyverse); library(janitor)
```

Processing the datasets to create a wide formating data for analysis, for each assemblage.

## Species X sites occurrence matrix

```{r}
data <- read.csv("data/species_site_occ2.csv", check.names=FALSE)
```

Long format
```{r}
data <- data %>% pivot_longer(cols = 3:182, names_to = "sp", values_to="occor")
str(data)
```

## Landscape and sites information

```{r}
env <- read.csv("data/sites_information.csv")
str(env)
```

## Species information

```{r}
sp <- read.csv("data/species_information.csv")
str(sp)
```

## Mergin information

```{r}
dataset <- data %>% left_join(sp[,3:11], "sp") %>% 
  left_join(env[,],by=c("landscape", "site"))
```

## Creating assemblages datasets 

Cleaning information columns and standardazing continuous variables for modeling.

```{r}
high.spe <- dataset %>% filter(matrix=="high_quality",
                               habitat_specif=="specialist") %>%
  
            select(landscape,site,sp,n.visit,occor,body_size,diet,nest,stratum,
                   frugivory,insectivory,lower_stratum,forest_land, 
                   forest_site400, forest_site600, forest_site800) %>%
            mutate(lbody_size = as.numeric(scale(log(body_size))),
                   frugivoryOrig = frugivory,
                   frugivory = as.numeric(scale(frugivory)),
                   insectivoryOrig = insectivory,
                   insectivory = as.numeric(scale(insectivory)),
                   lower_stratumOrig = lower_stratum,
                   lower_stratum = as.numeric(scale(lower_stratum)),
                   forest_landOrig = forest_land,
                   forest_land = as.numeric(scale(forest_land)),
                   forest_site400Orig = forest_site400,
                   forest_site400 = as.numeric(scale(forest_site400)),
                   forest_site600Orig = forest_site600,
                   forest_site600 = as.numeric(scale(forest_site600)),
                   forest_site800Orig = forest_site800,
                   forest_site800 = as.numeric(scale(forest_site800)),
                   ) %>% as.data.frame()

high.gen <- dataset %>% filter(matrix=="high_quality",
                               habitat_specif=="generalist")%>%
            select(landscape,site,sp,n.visit,occor,body_size,diet,nest,stratum,
                   frugivory,insectivory,lower_stratum,forest_land, 
                   forest_site400, forest_site600, forest_site800)%>%
            mutate(lbody_size = as.numeric(scale(log(body_size))),
                   frugivoryOrig = frugivory,
                   frugivory = as.numeric(scale(frugivory)),
                   insectivoryOrig = insectivory,
                   insectivory = as.numeric(scale(insectivory)),
                   lower_stratumOrig = lower_stratum,
                   lower_stratum = as.numeric(scale(lower_stratum)),
                   forest_landOrig = forest_land,
                   forest_land = as.numeric(scale(forest_land)),
                   forest_site400Orig = forest_site400,
                   forest_site400 = as.numeric(scale(forest_site400)),
                   forest_site600Orig = forest_site600,
                   forest_site600 = as.numeric(scale(forest_site600)),
                   forest_site800Orig = forest_site800,
                   forest_site800 = as.numeric(scale(forest_site800)),
                   ) %>% as.data.frame()

low.spe <- dataset %>% filter(matrix=="low_quality",
                              habitat_specif=="specialist")%>%
            select(landscape,site,sp,n.visit,occor,body_size,diet,nest,stratum,
                   frugivory,insectivory,lower_stratum,forest_land, 
                   forest_site400, forest_site600, forest_site800)%>%
            mutate(lbody_size = as.numeric(scale(log(body_size))),
                   frugivoryOrig = frugivory,
                   frugivory = as.numeric(scale(frugivory)),
                   insectivoryOrig = insectivory,
                   insectivory = as.numeric(scale(insectivory)),
                   lower_stratumOrig = lower_stratum,
                   lower_stratum = as.numeric(scale(lower_stratum)),
                   forest_landOrig = forest_land,
                   forest_land = as.numeric(scale(forest_land)),
                   forest_site400Orig = forest_site400,
                   forest_site400 = as.numeric(scale(forest_site400)),
                   forest_site600Orig = forest_site600,
                   forest_site600 = as.numeric(scale(forest_site600)),
                   forest_site800Orig = forest_site800,
                   forest_site800 = as.numeric(scale(forest_site800)),
                   ) %>% as.data.frame()

low.gen <- dataset %>% filter(matrix=="low_quality",
                              habitat_specif=="generalist")%>%
            select(landscape,site,sp,n.visit,occor,body_size,diet,nest,stratum,
                   frugivory,insectivory,lower_stratum,forest_land, 
                   forest_site400, forest_site600, forest_site800)%>%
            mutate(lbody_size = as.numeric(scale(log(body_size))),
                   frugivoryOrig = frugivory,
                   frugivory = as.numeric(scale(frugivory)),
                   insectivoryOrig = insectivory,
                   insectivory = as.numeric(scale(insectivory)),
                   lower_stratumOrig = lower_stratum,
                   lower_stratum = as.numeric(scale(lower_stratum)),
                   forest_landOrig = forest_land,
                   forest_land = as.numeric(scale(forest_land)),
                   forest_site400Orig = forest_site400,
                   forest_site400 = as.numeric(scale(forest_site400)),
                   forest_site600Orig = forest_site600,
                   forest_site600 = as.numeric(scale(forest_site600)),
                   forest_site800Orig = forest_site800,
                   forest_site800 = as.numeric(scale(forest_site800)),
                   ) %>% as.data.frame()
```

Selecting only the species that occur in the landscapes
```{r}
sp.high.spe <- high.spe %>% group_by(sp) %>% summarise(n=sum(occor)) %>% 
  filter(n>0) %>% select(sp)
high.spe <- high.spe %>% filter(sp %in% sp.high.spe$sp)

sp.high.gen <- high.gen %>% group_by(sp) %>% summarise(n=sum(occor)) %>% 
  filter(n>0) %>% select(sp)
high.gen <- high.gen %>% filter(sp %in% sp.high.gen$sp)

sp.low.spe <- low.spe %>% group_by(sp) %>% summarise(n=sum(occor)) %>% 
  filter(n>0) %>% select(sp)
low.spe <- low.spe %>% filter(sp %in% sp.low.spe$sp)

sp.low.gen <- low.gen %>% group_by(sp) %>% summarise(n=sum(occor)) %>% 
  filter(n>0) %>% select(sp)
low.gen <- low.gen %>% filter(sp %in% sp.low.gen$sp)
```

# Summary species richness

Total richness specialists and generalists in each matrix quality type.
```{r}
riq.high.spe <- length(unique(high.spe$sp))
riq.low.spe <- length(unique(low.spe$sp))
riq.spe <- length(unique(c(unique(low.spe$sp), unique(high.spe$sp))))
shared.spe <- riq.high.spe + riq.low.spe - riq.spe

riq.high.gen <- length(unique(high.gen$sp))
riq.low.gen <- length(unique(low.gen$sp))
riq.gen <- length(unique(c(unique(low.gen$sp), unique(high.gen$sp))))
shared.gen <- riq.high.gen + riq.low.gen - riq.gen  

riq.tot <- riq.gen + riq.spe
```

Richness per landscape and site
```{r}
# landscape
lcc.spe <- high.spe %>% filter(occor>0) %>% 
  group_by(landscape, sp) %>% 
  summarise(riq = n()) %>%
  group_by(landscape) %>%
  summarise(riq=n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
lpp.spe <- low.spe %>% filter(occor>0) %>% 
  group_by(landscape,  sp) %>% 
  summarise(riq = n()) %>%
  group_by(landscape) %>%
  summarise(riq=n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
land.sum <- rbind(lcc.spe, lpp.spe) %>% mutate(matrix = c("High", "low"))

# site
scc.spe <- high.spe %>% filter(occor>0) %>% 
  group_by(landscape, site, forest_site400) %>% 
  summarise(riq = n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
spp.spe <- low.spe %>% filter(occor>0) %>% 
  group_by(landscape, site, forest_site400) %>% 
  summarise(riq = n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
site.sum <- rbind(scc.spe, spp.spe) %>% mutate(matrix = c("High", "Low"))

# generalistas

# landscape
lcc.gen <- high.gen %>% filter(occor>0) %>% 
  group_by(landscape, sp) %>% 
  summarise(riq = n()) %>%
  group_by(landscape) %>%
  summarise(riq=n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
lpp.gen <- low.gen %>% filter(occor>0) %>% 
  group_by(landscape,  sp) %>% 
  summarise(riq = n()) %>%
  group_by(landscape) %>%
  summarise(riq=n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
gland.sum <- rbind(lcc.gen, lpp.gen) %>% mutate(matrix = c("High", "Low"))

# site
scc.gen <- high.gen %>% filter(occor>0) %>% 
  group_by(landscape, site, forest_site400) %>% 
  summarise(riq = n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
spp.gen <- low.gen %>% filter(occor>0) %>% 
  group_by(landscape, site, forest_site400) %>% 
  summarise(riq = n()) %>% ungroup() %>%
  summarise(mean = mean(riq), desv.pad = sd(riq),
            median = median(riq),
            max=max(riq), min=min(riq))
gsite.sum <- rbind(scc.gen, spp.gen) %>% mutate(matrix = c("High", "Low"))
```

# Summary trait between specialists and generalists


```{r}
bhigh.spe <- high.spe %>% group_by(sp) %>% summarise(body_size = mean(body_size),
                                     frugi = mean(frugivoryOrig),
                                     inse  = mean(insectivoryOrig),
                                     grou = mean(lower_stratumOrig),
                                     nest = first(nest),
                                     diet = first(diet),
                                     stratum =first(stratum),
                                     ) %>%
  mutate(dataset="high.spe") %>%
  as.data.frame()
blow.spe <- low.spe %>% group_by(sp) %>% summarise(body_size = mean(body_size),
                                     frugi = mean(frugivoryOrig),
                                     inse  = mean(insectivoryOrig),
                                     grou = mean(lower_stratumOrig),
                                     nest = first(nest),
                                     diet = first(diet),
                                     stratum =first(stratum),
                                     ) %>%
  mutate(dataset="low.spe") %>%
  as.data.frame()
bhigh.gen <- high.gen %>% group_by(sp) %>% summarise(body_size = mean(body_size),
                                     frugi = mean(frugivoryOrig),
                                     inse  = mean(insectivoryOrig),
                                     grou = mean(lower_stratumOrig),
                                     nest = first(nest),
                                     diet = first(diet),
                                     stratum =first(stratum),
                                     ) %>%
  mutate(dataset="high.gen") %>%
  as.data.frame()
blow.gen <- low.gen %>% group_by(sp) %>% summarise(body_size = mean(body_size),
                                     frugi = mean(frugivoryOrig),
                                     inse  = mean(insectivoryOrig),
                                     grou = mean(lower_stratumOrig),
                                     nest = first(nest),
                                     diet = first(diet),
                                     stratum =first(stratum),
                                     ) %>%
  mutate(dataset="low.gen") %>%
  as.data.frame()

bares <- rbind(bhigh.spe, blow.spe, bhigh.gen, blow.gen)
colnames(bares)[2:8] <- c("body mass", "% fruits", "% insects", "% lower strata",
                          "nest type", "main diet", "foraging strata")
```

```{r}
nbares <- bares %>% separate(dataset, c("matrix", "habitat")) %>% select(-matrix) %>%
  distinct() %>%
  mutate(`body mass` = log(`body mass`)) %>%
  mutate_at(c("body mass", '% fruits', '% insects', '% lower strata'), scale)
```

```{r, fig.cap="Boxplots of values for the traits measured as continuous variables for the specialists and generalists. Species from the two regions were grouped."}
nbares %>% gather("trait", "value", 2:5) %>%
  ggplot(aes(x=habitat, y=value)) + geom_boxplot() +
  facet_wrap(~trait) +
  scale_x_discrete(name = "", labels=c("Specialists", "Generalists"))
```

```{r tab1}
tab1 <- nbares %>% tabyl(`nest type`, habitat) %>% 
  adorn_percentages("col") %>% 
  adorn_pct_formatting(digits = 0) %>% adorn_ns() %>% rename(var=`nest type`)
tab2 <- nbares %>% tabyl(`main diet`, habitat) %>% 
  adorn_percentages("col") %>% 
  adorn_pct_formatting(digits = 0) %>% adorn_ns() %>% rename(var=`main diet`)
tab3 <- nbares %>% tabyl(`foraging strata`, habitat) %>% 
  adorn_percentages("col") %>% 
  adorn_pct_formatting(digits = 0) %>% adorn_ns()  %>% rename(var=`foraging strata`)

rbind(tab1,tab2,tab3) %>% rename(Traits = var, Specialists = spe, Generalists = gen) %>%
  kable()
```


## Saving datasets

```{r}
save(env, high.spe, high.gen,low.spe,low.gen, file="datasets.Rdata")
```


